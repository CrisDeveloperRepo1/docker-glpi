version: '3.8'

services:
  # 1. SERVICIO GLPI (Con imagen PHP limpia y fix de proxy)
  glpi:
    # Uso PHP/Apache para evitar el fallo del entrypoint
    image: php:8.1-apache
    container_name: glpi
    restart: always
    environment: 
      # Esto resuelve el bucle de redirección.
      - GLPI_TRUSTED_PROXIES=172.0.0.0/8
    
    volumes:
      # Monto el volumen en la raíz del servidor web de Apache.
      
      - glpi_data:/var/www/html
      
    depends_on:
      # Espero a que la base de datos esté lista.
      mysql:
        condition: service_healthy 

  # 2. SERVICIO PROXY NGINX (Para exponer el puerto 8080 y corregir encabezados)
  glpi_proxy:
    image: nginx:latest
    container_name: glpi_proxy
    restart: always
    # Expone el puerto 8080 del host al puerto 80 de Nginx
    ports:
      - "8080:80"
    volumes:
      # Monta tu archivo de configuración Nginx (el que tiene los encabezados X-Forwarded-*)
      - ./nginx.conf:/etc/nginx/conf.d/default.conf
    depends_on:
      - glpi 

  # 3. SERVICIO MYSQL (Base de Datos con Healthcheck)
  mysql:
    image: mysql:5.7
    container_name: glpi-mysql
    restart: always
    environment:
      # Credenciales usadas por GLPI
      - MYSQL_DATABASE=glpibd
      - MYSQL_ROOT_PASSWORD=rootpassword
      - MYSQL_USER=glpi_user
      - MYSQL_PASSWORD=glpi_password
    volumes:
      - db_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 20s
      retries: 10

volumes:
  glpi_data:
  db_data:
